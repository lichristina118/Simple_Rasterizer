# Introduction

This program is a simple rasterization engine that takes in a .dae or .obj file, its corresponding .json info file, and a skybox to output an interactive window showcasing the scene.

![Completed Bunny Scene](readme_refs/bunny.png)

# Pipeline Overview

![Graphics Pipeline](readme_refs/pipeline.png)

# Geometry Pass

The geometry pass, performed by the fragment shader
<span>`geopass.fs`</span>, requires a diffuse reflectance, and three
<span>`float`</span>’s: alpha, eta, and k\_s, in order to produce 4
<span>`vec3`</span>’s for the g-buffers: <span>`gNormal`</span> (surface
normals), <span>`gDiffuse_r`</span>, <span>`gAlpha`</span> ( =
<span>`vec3(alpha, eta, k_s)`</span>, and <span>`gConvert`</span>, with
each element of <span>`gConvert`</span> equaling 1 if the corresponding
element in <span>`gAlpha`</span> is flipped. In order to make sure that
all of the g-buffer values are in the range \([0,1]\), I stored
<span>`gNormal`</span> as <span>`(vNormal + 1.0) / 2.0`</span> with
<span>`vNormal`</span> as the vertex normal in world space. If
<span>`alpha > 1.0`</span> then I set `gAlpha.x = 1.0/alpha` and
`gConvert.x = 1.0`; similarly for <span>`eta`</span> and
<span>`k_s`</span>. The result is the following image showing all four
g-buffers:

![Normals, Diffuse Reflectance, Alpha/Eta/K\_s, and Convert
G-Buffers](readme_refs/gbuffers.png)

# Shadow Pass

For each point light, I rendered the geometry using the light position
as the camera position and generated a shadow-map buffer.

![Shadow Map](readme_refs/shadowmap.png)

# Lighting Pass

## Point light

For each point light, I used the g-buffers and the shadow map as the
input to generate the light and shadow effects. The result is blended
into the accumulation buffer including diffuse reflection and specular
reflection.

## Ambient Light

For each ambient light, the program calculates the ambient occlusion
effect by sampling random points within a hemisphere on top of the
fragment. If a point is within the geometry, it will be counted as
ambient occlusion.

![Point Light and Ambient Light Occlusion](readme_refs/ambientocclusion.png)

## Sun Sky

This adds the sun-sky effect using the Preetham model.

# Blur Pass and Merge Pass

The blur pass executes 4 blurs each with a horizon blur pass and a
vertical blur pass:

  - blur1: standard deviation: 6.2, radius: 24, mipmap level 1

  - blur2: standard deviation: 24.9 radius: 80, mipmap level 2

  - blur3: standard deviation: 81.0, radius: 243, mipmap level 3

  - blur4: standard deviation: 263, radius: 799, mipmap level 4

The result of each blur is saved into a mipmap of the temporary frame
buffer.  
The merge pass merges the above 4 blur results and the original image
with the weighted factors using the Spencer model:  
$0.8843g(x) + 0.1g(6.2,x) + 0.012g(24.9,x) + 0.0027g(81.0,x) + 0.001(263,x)$ 
The result is saved into a frame buffer called mergebuffer.

![Blurred Sun-sky](readme_refs/blur.png)

# Gamma Correction Pass

This reads from the merge buffer, performs the gamma correction, and
renders the image to screen.

# Skybox Implementation

The skybox and its mirror reflection are added to both
the forward and deferred renderer. In particular, a separate "skybox
pass" is added to draw the skybox images. To optimize the performance,
the depth value z for a pixel is always set to w (which is 1) in the
skybox vertex shader such that the skybox pixel will not be drawn if
there are anything in front of to it. The depth test is enabled and
`GL_LEQUAL` is set for depth function before the rendering.

![Forward Rendering with No Mirror Reflection](readme_refs/forward.png)

For the reflection in deferred rendering, a separate "skybox mirror
reflection" pass is added, where the normals from the g-buffers
generated by the geometry pass are used to calculate the reflection
vectors in the fragment shader. The reflection vector is used to sample
the skybox for pixel color, followed by the mirror reflection color
being added to the existing pixel color, as generated by the light and
shadow passes to form the final color for the pixel.

![Deferred Rendering with No Mirror Reflection](readme_refs/deferred.png)

